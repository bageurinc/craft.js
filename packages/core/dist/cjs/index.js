"use strict";"undefined"!=typeof window&&(window.__CRAFTJS__||(window.__CRAFTJS__={}),window.__CRAFTJS__["@craftjs/core"]="0.2.12"),Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@craftjs/utils"),t=require("react"),n=require("tiny-invariant"),r=require("lodash/isFunction"),o=require("lodash/cloneDeep");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function d(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var a=s(t),i=d(t),l=s(n),c=s(r),u=s(o);const p=a.default.createContext(null),h=({id:e,related:t=!1,children:n})=>a.default.createElement(p.Provider,{value:{id:e,related:t}},n);function f(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach(function(t){f(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function v(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n={};for(var r in e)if({}.hasOwnProperty.call(e,r)){if(-1!==t.indexOf(r))continue;n[r]=e[r]}return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)-1===t.indexOf(n=s[r])&&{}.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}const N=t.createContext(null),y=t.createContext(null),m=()=>t.useContext(y);function O(n){const r=m(),o=t.useContext(N);l.default(o,e.ERROR_USE_EDITOR_OUTSIDE_OF_EDITOR_CONTEXT);const s=e.useCollector(o,n),d=t.useMemo(()=>r&&r.createConnectorsUsage(),[r]);t.useEffect(()=>(d.register(),()=>{d.cleanup()}),[d]);const a=t.useMemo(()=>d&&e.wrapConnectorHooks(d.connectors),[d]);return E(E({},s),{},{connectors:a,inContext:!!o,store:o})}const R=["actions","query","connectors"];function T(n){const r=t.useContext(p);l.default(r,e.ERROR_USE_NODE_OUTSIDE_OF_EDITOR_CONTEXT);const{id:o,related:s}=r,d=O(e=>o&&e.nodes[o]&&n&&n(e.nodes[o])),{actions:a,connectors:i}=d,c=v(d,R),u=t.useMemo(()=>e.wrapConnectorHooks({connect:e=>i.connect(e,o),drag:e=>i.drag(e,o)}),[i,o]),h=t.useMemo(()=>({setProp:(e,t)=>{t?a.history.throttle(t).setProp(o,e):a.setProp(o,e)},setCustom:(e,t)=>{t?a.history.throttle(t).setCustom(o,e):a.setCustom(o,e)},setHidden:e=>a.setHidden(o,e)}),[a,o]);return E(E({},c),{},{id:o,related:s,inNodeContext:!!r,actions:h,connectors:u})}const _=["id","related","actions","inNodeContext","connectors"];function b(t){const n=T(t),{id:r,related:o,actions:s,inNodeContext:d,connectors:a}=n;return E(E({},v(n,_)),{},{actions:s,id:r,related:o,setProp:(t,n)=>(e.deprecationWarning("useNode().setProp()",{suggest:"useNode().actions.setProp()"}),s.setProp(t,n)),inNodeContext:d,connectors:a})}const D=({render:e})=>{const{connectors:{connect:t,drag:n}}=b();return"string"==typeof e.type?t(n(a.default.cloneElement(e))):e},C=()=>{const{type:e,props:n,nodes:r,hydrationTimestamp:o}=T(e=>({type:e.data.type,props:e.data.props,nodes:e.data.nodes,hydrationTimestamp:e._hydrationTimestamp}));return t.useMemo(()=>{let t=n.children;r&&r.length>0&&(t=a.default.createElement(a.default.Fragment,null,r.map(e=>a.default.createElement(I,{id:e,key:e}))));const o=a.default.createElement(e,n,t);return"string"==typeof e?a.default.createElement(D,{render:o}):o},[e,n,o,r])},x=({render:e})=>{const{hidden:t}=T(e=>({hidden:e.data.hidden})),{onRender:n}=O(e=>({onRender:e.options.onRender}));return t?null:a.default.createElement(n,{render:e||a.default.createElement(C,null)})},I=({id:e,render:t})=>a.default.createElement(h,{id:e},a.default.createElement(x,{render:t})),S={is:"div",canvas:!1,custom:{},hidden:!1},w={is:"type",canvas:"isCanvas"};function k({id:n,children:r,...o}){const{is:s}={...S,...o},{query:d,actions:i}=O(),{id:c,inNodeContext:u}=T(),[p]=t.useState(()=>{l.default(!!n,e.ERROR_TOP_LEVEL_ELEMENT_NO_ID);const t=d.node(c).get();if(u){const e=t.data.linkedNodes[n]?d.node(t.data.linkedNodes[n]).get():null;if(e&&e.data.type===s)return e.id;const l=a.default.createElement(k,o,r),u=d.parseReactElement(l).toNodeTree();return i.history.ignore().addLinkedNodeFromTree(u,c,n),u.rootNodeId}return null});return p?a.default.createElement(I,{id:p}):null}const L=()=>e.deprecationWarning("<Canvas />",{suggest:"<Element canvas={true} />"});function Canvas({...e}){return t.useEffect(()=>L(),[]),a.default.createElement(k,{...e,canvas:!0})}const P=()=>{const{timestamp:t}=O(t=>({timestamp:t.nodes[e.ROOT_NODE]&&t.nodes[e.ROOT_NODE]._hydrationTimestamp}));return t?a.default.createElement(I,{id:e.ROOT_NODE,key:t}):null};var j;exports.NodeSelectorType=void 0,(j=exports.NodeSelectorType||(exports.NodeSelectorType={}))[j.Any=0]="Any",j[j.Id=1]="Id",j[j.Obj=2]="Obj";const A=e=>{const{addLinkedNodeFromTree:t,setDOM:n,setNodeEvent:r,replaceNodes:o,reset:s,...d}=e;return d};function M(e){const{connectors:n,actions:r,query:o,store:s,...d}=O(e),a=A(r);return{connectors:n,actions:t.useMemo(()=>({...a,history:{...a.history,ignore:(...e)=>A(a.history.ignore(...e)),throttle:(...e)=>A(a.history.throttle(...e))}}),[a]),query:o,store:s,...d}}const q=e=>Object.fromEntries?Object.fromEntries(e):e.reduce((e,t)=>{let[n,r]=t;return E(E({},e),{},{[n]:r})},{}),F=(t,n,r)=>{const o=Array.isArray(n)?n:[n],s=E({existOnly:!1,idOnly:!1},r||{}),d=o.filter(e=>!!e).map(e=>"string"==typeof e?{node:t[e],exists:!!t[e]}:"object"!=typeof e||s.idOnly?{node:null,exists:!1}:{node:e,exists:!!t[e.id]});return s.existOnly&&l.default(0===d.filter(e=>!e.exists).length,e.ERROR_INVALID_NODEID),d},V=["history"],H=(t,n)=>{const r=(n,r,s)=>{const d=(r,o)=>{const s=n.nodes[r];"string"!=typeof s.data.type&&l.default(t.options.resolver[s.data.name],e.ERROR_NOT_IN_RESOLVER.replace("%node_type%","".concat(s.data.type.name))),t.nodes[r]=E(E({},s),{},{data:E(E({},s.data),{},{parent:o})}),s.data.nodes.length>0&&(delete t.nodes[r].data.props.children,s.data.nodes.forEach(e=>d(e,s.id))),Object.values(s.data.linkedNodes).forEach(e=>d(e,s.id))};if(d(n.rootNodeId,r),!r&&n.rootNodeId===e.ROOT_NODE)return;const a=o(r);if("child"===s.type){const e=s.index;return void(null!=e?a.data.nodes.splice(e,0,n.rootNodeId):a.data.nodes.push(n.rootNodeId))}a.data.linkedNodes[s.id]=n.rootNodeId},o=n=>{l.default(n,e.ERROR_NOPARENT);const r=t.nodes[n];return l.default(r,e.ERROR_INVALID_NODEID),r},s=e=>{const n=t.nodes[e],r=t.nodes[n.data.parent];if(n.data.nodes&&[...n.data.nodes].forEach(e=>s(e)),n.data.linkedNodes&&Object.values(n.data.linkedNodes).map(e=>s(e)),r.data.nodes.includes(e)){const t=r.data.nodes;t.splice(t.indexOf(e),1)}else{const e=Object.keys(r.data.linkedNodes).find(e=>r.data.linkedNodes[e]===e);e&&delete r.data.linkedNodes[e]}((e,t)=>{Object.keys(e.events).forEach(n=>{const r=e.events[n];r&&r.has&&r.has(t)&&(e.events[n]=new Set(Array.from(r).filter(e=>t!==e)))})})(t,e),delete t.nodes[e]};return{addLinkedNodeFromTree(e,t,n){const d=o(t).data.linkedNodes[n];d&&s(d),r(e,t,{type:"linked",id:n})},add(t,n,o){let s=[t];Array.isArray(t)&&(e.deprecationWarning("actions.add(node: Node[])",{suggest:"actions.add(node: Node)"}),s=t),s.forEach(e=>{r({nodes:{[e.id]:e},rootNodeId:e.id},n,{type:"child",index:o})})},addNodeTree(e,t,n){r(e,t,{type:"child",index:n})},delete(r){F(t.nodes,r,{existOnly:!0,idOnly:!0}).forEach(t=>{let{node:r}=t;l.default(!n.node(r.id).isTopLevelNode(),e.ERROR_DELETE_TOP_LEVEL_NODE),s(r.id)})},deserialize(t){const r="string"==typeof t?JSON.parse(t):t,o=Object.keys(r).map(t=>{let o=t;return t===e.DEPRECATED_ROOT_NODE&&(o=e.ROOT_NODE),[o,n.parseSerializedNode(r[t]).toNode(e=>e.id=o)]});this.replaceNodes(q(o))},move(e,r,o){const s=F(t.nodes,e,{existOnly:!0}),d=t.nodes[r],a=new Set;s.forEach((e,s)=>{let{node:i}=e;const l=i.id,c=i.data.parent;n.node(r).isDroppable([l],e=>{throw new Error(e)}),t.options.onBeforeMoveEnd(i,d,t.nodes[c]);const u=t.nodes[c].data.nodes;a.add(u);const p=u.indexOf(l);u[p]="$$",d.data.nodes.splice(o+s,0,l),t.nodes[l].data.parent=r}),a.forEach(e=>{const t=e.length;[...e].reverse().forEach((n,r)=>{"$$"===n&&e.splice(t-1-r,1)})})},replaceNodes(e){this.clearEvents(),t.nodes=e},clearEvents(){this.setNodeEvent("selected",null),this.setNodeEvent("hovered",null),this.setNodeEvent("dragged",null),this.setIndicator(null)},reset(){this.clearEvents(),this.replaceNodes({})},setOptions(e){e(t.options)},setNodeEvent(e,n){if(t.events[e].forEach(n=>{t.nodes[n]&&(t.nodes[n].events[e]=!1)}),t.events[e]=new Set,!n)return;const r=F(t.nodes,n,{idOnly:!0,existOnly:!0}),o=new Set(r.map(e=>{let{node:t}=e;return t.id}));o.forEach(n=>{t.nodes[n].events[e]=!0}),t.events[e]=o},setCustom(e,n){F(t.nodes,e,{idOnly:!0,existOnly:!0}).forEach(e=>{let{node:r}=e;return n(t.nodes[r.id].data.custom)})},setDOM(e,n){t.nodes[e]&&(t.nodes[e].dom=n)},setIndicator(e){e&&(!e.placement.parent.dom||e.placement.currentNode&&!e.placement.currentNode.dom)||(t.indicator=e)},setHidden(e,n){t.nodes[e].data.hidden=n},setProp(e,n){F(t.nodes,e,{idOnly:!0,existOnly:!0}).forEach(e=>{let{node:r}=e;return n(t.nodes[r.id].data.props)})},selectNode(e){if(e){const n=F(t.nodes,e,{idOnly:!0,existOnly:!0});this.setNodeEvent("selected",n.map(e=>{let{node:t}=e;return t.id}))}else this.setNodeEvent("selected",null);this.setNodeEvent("hovered",null)}}};let z=null;const W=(t,n)=>{if("string"==typeof n)return n;const r=((e,t)=>{const n=(e=>{if(z&&z.resolver===e)return z.reversed;z={resolver:e,reversed:new Map};for(const[t,n]of Object.entries(e))z.reversed.set(n,t);return z.reversed})(e).get(t);return void 0!==n?n:null})(t,n);var o;return l.default(r,e.ERROR_NOT_IN_RESOLVER.replace("%node_type%",(o=n).name||o.displayName)),r},B=(e,t)=>"string"==typeof e?e:{resolvedName:W(t,e)},U=(e,n)=>{let{type:r,isCanvas:o,props:s}=e;return s=Object.keys(s).reduce((e,r)=>{const o=s[r];return null==o||"function"==typeof o||(e[r]="children"===r&&"string"!=typeof o?t.Children.map(o,e=>"string"==typeof e?e:U(e,n)):"function"==typeof o.type?U(o,n):o),e},{}),{type:B(r,n),isCanvas:!!o,props:s}},J=(e,t)=>{const{type:n,props:r,isCanvas:o,name:s,...d}=e;return{...U({type:n,isCanvas:o,props:r},t),...d}};function $(t,n){l.default("string"==typeof n,e.ERROR_INVALID_NODE_ID);const r=t.nodes[n],o=e=>$(t,e);return{isCanvas:()=>!!r.data.isCanvas,isRoot:()=>r.id===e.ROOT_NODE,isLinkedNode:()=>r.data.parent&&o(r.data.parent).linkedNodes().includes(r.id),isTopLevelNode(){return this.isRoot()||this.isLinkedNode()},isDeletable(){return!this.isTopLevelNode()},isParentOfTopLevelNodes:()=>r.data.linkedNodes&&Object.keys(r.data.linkedNodes).length>0,isParentOfTopLevelCanvas(){return e.deprecationWarning("query.node(id).isParentOfTopLevelCanvas",{suggest:"query.node(id).isParentOfTopLevelNodes"}),this.isParentOfTopLevelNodes()},isSelected:()=>t.events.selected.has(n),isHovered:()=>t.events.hovered.has(n),isDragged:()=>t.events.dragged.has(n),get:()=>r,ancestors(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return function n(r){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const d=t.nodes[r];return d?(o.push(r),d.data.parent?((e||!e&&0===s)&&(o=n(d.data.parent,o,s+1)),o):o):o}(r.data.parent)},descendants(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1?arguments[1]:void 0;return function n(s){let d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return(e||!e&&0===a)&&t.nodes[s]?("childNodes"!==r&&o(s).linkedNodes().forEach(e=>{d.push(e),d=n(e,d,a+1)}),"linkedNodes"!==r&&o(s).childNodes().forEach(e=>{d.push(e),d=n(e,d,a+1)}),d):d}(n)},linkedNodes:()=>Object.values(r.data.linkedNodes||{}),childNodes:()=>r.data.nodes||[],isDraggable(n){try{const n=r;return l.default(!this.isTopLevelNode(),e.ERROR_MOVE_TOP_LEVEL_NODE),l.default($(t,n.data.parent).isCanvas(),e.ERROR_MOVE_NONCANVAS_CHILD),l.default(n.rules.canDrag(n,o),e.ERROR_CANNOT_DRAG),!0}catch(e){return n&&n(e),!1}},isDroppable(n,s){const d=F(t.nodes,n),a=r;try{l.default(this.isCanvas(),e.ERROR_MOVE_TO_NONCANVAS_PARENT),l.default(a.rules.canMoveIn(d.map(e=>e.node),a,o),e.ERROR_MOVE_INCOMING_PARENT);const n={};return d.forEach(r=>{let{node:s,exists:d}=r;if(l.default(s.rules.canDrop(a,s,o),e.ERROR_MOVE_CANNOT_DROP),!d)return;l.default(!o(s.id).isTopLevelNode(),e.ERROR_MOVE_TOP_LEVEL_NODE);const i=o(s.id).descendants(!0);l.default(!i.includes(a.id)&&a.id!==s.id,e.ERROR_MOVE_TO_DESCENDANT);const c=s.data.parent&&t.nodes[s.data.parent];l.default(c.data.isCanvas,e.ERROR_MOVE_NONCANVAS_CHILD),l.default(c||!c&&!t.nodes[s.id],e.ERROR_DUPLICATE_NODEID),c.id!==a.id&&(n[c.id]||(n[c.id]=[]),n[c.id].push(s))}),Object.keys(n).forEach(r=>{const s=t.nodes[r];l.default(s.rules.canMoveOut(n[r],s,o),e.ERROR_MOVE_OUTGOING_PARENT)}),!0}catch(e){return s&&s(e),!1}},toSerializedNode:()=>J(r.data,t.options.resolver),toNodeTree(e){const t=[n,...this.descendants(!0,e)].reduce((e,t)=>(e[t]=o(t).get(),e),{});return{rootNodeId:n,nodes:t}},decendants(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e.deprecationWarning("query.node(id).decendants",{suggest:"query.node(id).descendants"}),this.descendants(t)},isTopLevelCanvas(){return!this.isRoot()&&!r.data.parent}}}function G(e,t,n,r){let o={parent:e,index:0,where:"before"},s=0,d=0,a=0,i=0,l=0,c=0,u=0;for(let e=0,p=t.length;e<p;e++){const p=t[e];if(a=p.left+p.outerWidth,u=p.top+p.outerHeight,l=p.left+p.outerWidth/2,c=p.top+p.outerHeight/2,!(d&&p.left>d||i&&c>=i||s&&a<s))if(o.index=e,p.inFlow){if(r<c){o.where="before";break}o.where="after"}else r<u&&(i=u),n<l?(d=l,o.where="before"):(s=l,o.where="after")}return o}const X=e=>"string"==typeof e?e:e.name;function Y(t,n){let r=t.data.type;const o={id:t.id||e.getRandomId(),_hydrationTimestamp:Date.now(),data:E({type:r,name:X(r),displayName:X(r),props:{},custom:{},parent:null,isCanvas:!1,hidden:!1,nodes:[],linkedNodes:{}},t.data),info:{},related:{},events:{selected:!1,dragged:!1,hovered:!1},rules:{canDrag:()=>!0,canDrop:()=>!0,canMoveIn:()=>!0,canMoveOut:()=>!0},dom:null};if(o.data.type===k||o.data.type===Canvas){const e=E(E({},S),o.data.props);o.data.props=Object.keys(o.data.props).reduce((t,n)=>(Object.keys(S).includes(n)?o.data[w[n]||n]=e[n]:t[n]=o.data.props[n],t),{}),r=o.data.type,o.data.name=X(r),o.data.displayName=X(r),o.data.type===Canvas&&(o.data.isCanvas=!0,L())}n&&n(o);const s=r.craft;if(s){if(o.data.displayName=s.displayName||s.name||o.data.displayName,o.data.props=E(E({},s.props||s.defaultProps||{}),o.data.props),o.data.custom=E(E({},s.custom||{}),o.data.custom),null!=s.isCanvas&&(o.data.isCanvas=s.isCanvas),s.rules&&Object.keys(s.rules).forEach(e=>{["canDrag","canDrop","canMoveIn","canMoveOut"].includes(e)&&(o.rules[e]=s.rules[e])}),s.related){const e={id:o.id,related:!0};Object.keys(s.related).forEach(t=>{o.related[t]=n=>a.default.createElement(h,e,a.default.createElement(s.related[t],n))})}s.info&&(o.info=s.info)}return o}const K=(e,t,n)=>{let{type:r,props:o}=e;const s=((e,t)=>"object"==typeof e&&e.resolvedName?"Canvas"===e.resolvedName?Canvas:t[e.resolvedName]:"string"==typeof e?e:null)(r,t);if(!s)return;o=Object.keys(o).reduce((e,n)=>{const r=o[n];return e[n]=null==r?null:"object"==typeof r&&r.resolvedName?K(r,t):"children"===n&&Array.isArray(r)?r.map(e=>"string"==typeof e?e:K(e,t)):r,e},{}),n&&(o.key=n);const d={...a.default.createElement(s,{...o})};return{...d,name:W(t,d.type)}},Q=(e,t)=>{if(t.length<1)return{[e.id]:e};const n=t.map(({rootNodeId:e})=>e),r={...e,data:{...e.data,nodes:n}};return t.reduce((t,n)=>{const r=n.nodes[n.rootNodeId];return{...t,...n.nodes,[r.id]:{...r,data:{...r.data,parent:e.id}}}},{[e.id]:r})};function Z(n){const r=n&&n.options,o=()=>Z(n);return{getDropPlaceholder:(t,r,s,d=e=>n.nodes[e.id].dom)=>{const a=n.nodes[r],i=o().node(a.id).isCanvas()?a:n.nodes[a.data.parent];if(!i)return;const l=i.data.nodes||[],c=G(i,l?l.reduce((t,r)=>{const o=d(n.nodes[r]);if(o){const n={id:r,...e.getDOMInfo(o)};t.push(n)}return t},[]):[],s.x,s.y),u=l.length&&n.nodes[l[c.index]],p={placement:{...c,currentNode:u},error:null};return F(n.nodes,t).forEach(({node:e,exists:t})=>{t&&o().node(e.id).isDraggable(e=>p.error=e)}),o().node(i.id).isDroppable(t,e=>p.error=e),p},getOptions:()=>r,getNodes:()=>n.nodes,node:e=>$(n,e),getSerializedNodes(){const e=Object.keys(n.nodes).map(e=>[e,this.node(e).toSerializedNode()]);return q(e)},getEvent:e=>function(e,t){const n=e.events[t];return{contains:e=>n.has(e),isEmpty(){return 0===this.all().length},first(){return this.all()[0]},last(){const e=this.all();return e[e.length-1]},all:()=>Array.from(n),size(){return this.all().length},at(e){return this.all()[e]},raw:()=>n}}(n,e),serialize(){return JSON.stringify(this.getSerializedNodes())},parseReactElement:e=>({toNodeTree(r){let s=function(e,n){let r=e;return"string"==typeof r&&(r=a.default.createElement(t.Fragment,{},r)),Y({data:{type:r.type,props:{...r.props}}},e=>{n&&n(e,r)})}(e,(e,t)=>{const o=W(n.options.resolver,e.data.type);e.data.displayName=e.data.displayName||o,e.data.name=o,r&&r(e,t)}),d=[];return e.props&&e.props.children&&(d=a.default.Children.toArray(e.props.children).reduce((e,t)=>(a.default.isValidElement(t)&&e.push(o().parseReactElement(t).toNodeTree(r)),e),[])),((e,t)=>({rootNodeId:e.id,nodes:Q(e,t)}))(s,d)}}),parseSerializedNode:t=>({toNode(r){const s=((t,n)=>{const{type:r,props:o,...s}=t;l.default(void 0!==r&&"string"==typeof r||void 0!==r&&void 0!==r.resolvedName,e.ERROR_DESERIALIZE_COMPONENT_NOT_IN_RESOLVER.replace("%displayName%",t.displayName).replace("%availableComponents%",Object.keys(n).join(", ")));const{type:d,name:a,props:i}=K(t,n),{parent:c,custom:u,displayName:p,isCanvas:h,nodes:f,hidden:g}=s;return{type:d,name:a,displayName:p||a,props:i,custom:u||{},isCanvas:!!h,hidden:!!g,parent:c,linkedNodes:s.linkedNodes||s._childCanvas||{},nodes:f||[]}})(t,n.options.resolver);l.default(s.type,e.ERROR_NOT_IN_RESOLVER);const d="string"==typeof r&&r;return d&&e.deprecationWarning("query.parseSerializedNode(...).toNode(id)",{suggest:"query.parseSerializedNode(...).toNode(node => node.id = id)"}),o().parseFreshNode({...d?{id:d}:{},data:s}).toNode(!d&&r)}}),parseFreshNode:t=>({toNode:r=>Y(t,t=>{t.data.parent===e.DEPRECATED_ROOT_NODE&&(t.data.parent=e.ROOT_NODE);const o=W(n.options.resolver,t.data.type);l.default(null!==o,e.ERROR_NOT_IN_RESOLVER),t.data.displayName=t.data.displayName||o,t.data.name=o,r&&r(t)})}),createNode(t,n){e.deprecationWarning(`query.createNode(${t})`,{suggest:`query.parseReactElement(${t}).toNodeTree()`});const r=this.parseReactElement(t).toNodeTree(),o=r.nodes[r.rootNodeId];return n?(n.id&&(o.id=n.id),n.data&&(o.data={...o.data,...n.data}),o):o},getState:()=>n}}class ee extends e.EventHandlers{handlers(){return{connect:(e,t)=>{},select:(e,t)=>{},hover:(e,t)=>{},drag:(e,t)=>{},drop:(e,t)=>{},create:(e,t,n)=>{}}}}const te=e=>{e.preventDefault()};class ne{constructor(e,t){f(this,"store",void 0),f(this,"dragTarget",void 0),f(this,"currentDropTargetId",void 0),f(this,"currentDropTargetCanvasAncestorId",void 0),f(this,"currentIndicator",null),f(this,"currentTargetId",void 0),f(this,"currentTargetChildDimensions",void 0),f(this,"dragError",void 0),f(this,"draggedNodes",void 0),f(this,"onScrollListener",void 0),this.store=e,this.dragTarget=t,this.currentDropTargetId=null,this.currentDropTargetCanvasAncestorId=null,this.currentTargetId=null,this.currentTargetChildDimensions=null,this.currentIndicator=null,this.dragError=null,this.draggedNodes=this.getDraggedNodes(),this.validateDraggedNodes(),this.onScrollListener=this.onScroll.bind(this),window.addEventListener("scroll",this.onScrollListener,!0),window.addEventListener("dragover",te,!1)}cleanup(){window.removeEventListener("scroll",this.onScrollListener,!0),window.removeEventListener("dragover",te,!1)}onScroll(t){const n=t.target,r=this.store.query.node(e.ROOT_NODE).get();n instanceof Element&&r&&r.dom&&n.contains(r.dom)&&(this.currentTargetChildDimensions=null)}getDraggedNodes(){return F(this.store.query.getNodes(),"new"===this.dragTarget.type?this.dragTarget.tree.nodes[this.dragTarget.tree.rootNodeId]:this.dragTarget.nodes)}validateDraggedNodes(){"new"!==this.dragTarget.type&&this.draggedNodes.forEach(e=>{let{node:t,exists:n}=e;n&&this.store.query.node(t.id).isDraggable(e=>{this.dragError=e})})}isNearBorders(e,t,n){const{top:r,bottom:o,left:s,right:d}=e;return r+ne.BORDER_OFFSET>n||o-ne.BORDER_OFFSET<n||s+ne.BORDER_OFFSET>t||d-ne.BORDER_OFFSET<t}isDiff(e){return!this.currentIndicator||this.currentIndicator.placement.parent.id!==e.parent.id||this.currentIndicator.placement.index!==e.index||this.currentIndicator.placement.where!==e.where}getChildDimensions(t){const n=this.currentTargetChildDimensions;return this.currentTargetId===t.id&&n?n:t.data.nodes.reduce((t,n)=>{const r=this.store.query.node(n).get().dom;return r&&t.push(E({id:n},e.getDOMInfo(r))),t},[])}getCanvasAncestor(e){if(e===this.currentDropTargetId&&this.currentDropTargetCanvasAncestorId){const e=this.store.query.node(this.currentDropTargetCanvasAncestorId).get();if(e)return e}const t=e=>{const n=this.store.query.node(e).get();return n&&n.data.isCanvas?n:n.data.parent?t(n.data.parent):null};return t(e)}computeIndicator(t,n,r){let o=this.getCanvasAncestor(t);if(!o)return;if(this.currentDropTargetId=t,this.currentDropTargetCanvasAncestorId=o.id,o.data.parent&&this.isNearBorders(e.getDOMInfo(o.dom),n,r)&&!this.store.query.node(o.id).isLinkedNode()&&(o=this.store.query.node(o.data.parent).get()),!o)return;this.currentTargetChildDimensions=this.getChildDimensions(o),this.currentTargetId=o.id;const s=G(o,this.currentTargetChildDimensions,n,r);if(!this.isDiff(s))return;let d=this.dragError;d||this.store.query.node(o.id).isDroppable(this.draggedNodes.map(e=>e.node),e=>{d=e});const a=o.data.nodes[s.index],i=a&&this.store.query.node(a).get();return this.currentIndicator={placement:E(E({},s),{},{currentNode:i}),error:d},this.currentIndicator}getIndicator(){return this.currentIndicator}}f(ne,"BORDER_OFFSET",10);const re=function(e,t){if(1===t.length||arguments.length>2&&void 0!==arguments[2]&&arguments[2]){const{width:n,height:r}=t[0].getBoundingClientRect(),o=t[0].cloneNode(!0);return o.style.position="absolute",o.style.left="-100%",o.style.top="-100%",o.style.width="".concat(n,"px"),o.style.height="".concat(r,"px"),o.style.pointerEvents="none",o.classList.add("drag-shadow"),document.body.appendChild(o),e.dataTransfer.setDragImage(o,0,0),o}const n=document.createElement("div");return n.style.position="absolute",n.style.left="-100%",n.style.top="-100%",n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.classList.add("drag-shadow-container"),t.forEach(e=>{const{width:t,height:r,top:o,left:s}=e.getBoundingClientRect(),d=e.cloneNode(!0);d.style.position="absolute",d.style.left="".concat(s,"px"),d.style.top="".concat(o,"px"),d.style.width="".concat(t,"px"),d.style.height="".concat(r,"px"),d.classList.add("drag-shadow"),n.appendChild(d)}),document.body.appendChild(n),e.dataTransfer.setDragImage(n,e.clientX,e.clientY),n};class oe extends ee{constructor(){super(...arguments),f(this,"draggedElementShadow",void 0),f(this,"dragTarget",void 0),f(this,"positioner",null),f(this,"currentSelectedElementIds",[])}onDisable(){this.options.store.actions.clearEvents()}handlers(){const e=this.options.store;return{connect:(t,n)=>(e.actions.setDOM(n,t),this.reflect(e=>{e.select(t,n),e.hover(t,n),e.drop(t,n)})),select:(t,n)=>{const r=this.addCraftEventListener(t,"mousedown",t=>{t.craft.stopPropagation();let r=[];if(n){const{query:o}=e,s=o.getEvent("selected").all();(this.options.isMultiSelectEnabled(t)||s.includes(n))&&(r=s.filter(e=>{const t=o.node(e).descendants(!0),r=o.node(e).ancestors(!0);return!t.includes(n)&&!r.includes(n)})),r.includes(n)||r.push(n)}e.actions.setNodeEvent("selected",r)}),o=this.addCraftEventListener(t,"click",t=>{t.craft.stopPropagation();const{query:r}=e,o=r.getEvent("selected").all(),s=this.options.isMultiSelectEnabled(t),d=this.currentSelectedElementIds.includes(n);let a=[...o];s&&d?(a.splice(a.indexOf(n),1),e.actions.setNodeEvent("selected",a)):!s&&o.length>1&&(a=[n],e.actions.setNodeEvent("selected",a)),this.currentSelectedElementIds=a});return()=>{r(),o()}},hover:(t,n)=>{const r=this.addCraftEventListener(t,"mouseover",t=>{t.craft.stopPropagation(),e.actions.setNodeEvent("hovered",n)});let o=null;return this.options.removeHoverOnMouseleave&&(o=this.addCraftEventListener(t,"mouseleave",t=>{t.craft.stopPropagation(),e.actions.setNodeEvent("hovered",null)})),()=>{r(),o&&o()}},drop:(t,n)=>{const r=this.addCraftEventListener(t,"dragover",t=>{if(t.craft.stopPropagation(),t.preventDefault(),!this.positioner)return;const r=this.positioner.computeIndicator(n,t.clientX,t.clientY);r&&e.actions.setIndicator(r)}),o=this.addCraftEventListener(t,"dragenter",e=>{e.craft.stopPropagation(),e.preventDefault()});return()=>{o(),r()}},drag:(t,n)=>{if(!e.query.node(n).isDraggable())return()=>{};t.setAttribute("draggable","true");const r=this.addCraftEventListener(t,"dragstart",t=>{t.craft.stopPropagation();const{query:r,actions:o}=e;let s=r.getEvent("selected").all();const d=this.options.isMultiSelectEnabled(t);this.currentSelectedElementIds.includes(n)||(s=d?[...s,n]:[n],e.actions.setNodeEvent("selected",s)),o.setNodeEvent("dragged",s);const a=s.map(e=>r.node(e).get().dom);this.draggedElementShadow=re(t,a,oe.forceSingleDragShadow),this.dragTarget={type:"existing",nodes:s},this.positioner=new ne(this.options.store,this.dragTarget)}),o=this.addCraftEventListener(t,"dragend",t=>{t.craft.stopPropagation(),this.dropElement((t,n)=>{"new"!==t.type&&e.actions.move(t.nodes,n.placement.parent.id,n.placement.index+("after"===n.placement.where?1:0))})});return()=>{t.setAttribute("draggable","false"),r(),o()}},create:(t,n,r)=>{t.setAttribute("draggable","true");const o=this.addCraftEventListener(t,"dragstart",t=>{let r;if(t.craft.stopPropagation(),"function"==typeof n){const t=n();r=a.default.isValidElement(t)?e.query.parseReactElement(t).toNodeTree():t}else r=e.query.parseReactElement(n).toNodeTree();this.draggedElementShadow=re(t,[t.currentTarget],oe.forceSingleDragShadow),this.dragTarget={type:"new",tree:r},this.positioner=new ne(this.options.store,this.dragTarget)}),s=this.addCraftEventListener(t,"dragend",t=>{t.craft.stopPropagation(),this.dropElement((t,n)=>{"existing"!==t.type&&(e.actions.addNodeTree(t.tree,n.placement.parent.id,n.placement.index+("after"===n.placement.where?1:0)),r&&c.default(r.onCreate)&&r.onCreate(t.tree))})});return()=>{t.removeAttribute("draggable"),o(),s()}}}}dropElement(e){const t=this.options.store;if(!this.positioner)return;const n=this.draggedElementShadow,r=this.positioner.getIndicator();this.dragTarget&&r&&!r.error&&e(this.dragTarget,r),n&&(n.parentNode.removeChild(n),this.draggedElementShadow=null),this.dragTarget=null,t.actions.setIndicator(null),t.actions.setNodeEvent("dragged",null),this.positioner.cleanup(),this.positioner=null}}function se(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,o=0,s=0,d=0,a=0,i=e.where;return n?n.inFlow?(d=n.outerWidth,a=r,o="before"===i?n.top:n.bottom,s=n.left):(d=r,a=n.outerHeight,o=n.top,s="before"===i?n.left:n.left+n.outerWidth):t&&(o=t.top+t.padding.top,s=t.left+t.padding.left,d=t.outerWidth-t.padding.right-t.padding.left-t.margin.left-t.margin.right,a=r),{top:"".concat(o,"px"),left:"".concat(s,"px"),width:"".concat(d,"px"),height:"".concat(a,"px")}}f(oe,"forceSingleDragShadow",e.isChromium()&&e.isLinux());const de=()=>{const{indicator:n,indicatorOptions:r,enabled:o}=O(e=>({indicator:e.indicator,indicatorOptions:e.options.indicator,enabled:e.options.enabled})),s=m();return t.useEffect(()=>{s&&(o?s.enable():s.disable())},[o,s]),n?a.default.createElement(e.RenderIndicator,{className:r.className,style:{...se(n.placement,e.getDOMInfo(n.placement.parent.dom),n.placement.currentNode&&e.getDOMInfo(n.placement.currentNode.dom),r.thickness),backgroundColor:n.error?r.error:r.success,transition:r.transition||"0.2s ease-in",...r.style??{}},parentDom:n.placement.parent.dom}):null},ae=({children:e})=>{const n=t.useContext(N),r=t.useMemo(()=>n.query.getOptions().handlers(n),[n]);return r?a.default.createElement(y.Provider,{value:r},a.default.createElement(de,null),e):null},ie={nodes:{},events:{dragged:new Set,selected:new Set,hovered:new Set},indicator:null,options:{onNodesChange:()=>null,onRender:({render:e})=>e,onBeforeMoveEnd:()=>null,resolver:{},enabled:!0,indicator:{error:"red",success:"rgb(98, 196, 98)"},handlers:e=>new oe({store:e,removeHoverOnMouseleave:!1,isMultiSelectEnabled:e=>!!e.metaKey}),normalizeNodes:()=>{}}},le={methods:(e,t)=>E(E({},H(e,t)),{},{setState(t){const n=v(this,V);t(e,n)}}),ignoreHistoryForActions:["setDOM","setNodeEvent","selectNode","clearEvents","setOptions","setIndicator"],normalizeHistory:e=>{Object.keys(e.events).forEach(t=>{Array.from(e.events[t]||[]).forEach(n=>{e.nodes[n]||e.events[t].delete(n)})}),Object.keys(e.nodes).forEach(t=>{const n=e.nodes[t];Object.keys(n.events).forEach(t=>{n.events[t]&&e.events[t]&&!e.events[t].has(n.id)&&(n.events[t]=!1)})})}},ce=(t,n)=>e.useMethods(le,{...ie,options:{...ie.options,...t}},Z,n),ue=["events","data"],pe=["nodes"],he=["nodes"],fe=["_hydrationTimestamp","rules"],ge=["_hydrationTimestamp","rules"],Ee=e=>{const{events:t,data:{nodes:n,linkedNodes:r}}=e,o=v(e,ue),s=Y(u.default(e));return{node:e=E(E(E({},s),o),{},{events:E(E({},s.events),t),dom:e.dom||s.dom}),childNodes:n,linkedNodes:r}},ve=e=>{const t={},n=e=>{const{node:r,childNodes:o,linkedNodes:s}=Ee(e);t[r.id]=r,o&&o.forEach((e,o)=>{const{node:s,childNodes:d,linkedNodes:a}=Ee(e);s.data.parent=r.id,t[s.id]=s,r.data.nodes[o]=s.id,n(E(E({},s),{},{data:E(E({},s.data),{},{nodes:d||[],linkedNodes:a||{}})}))}),s&&Object.keys(s).forEach(e=>{const{node:o,childNodes:d,linkedNodes:a}=Ee(s[e]);r.data.linkedNodes[e]=o.id,o.data.parent=r.id,t[o.id]=o,n(E(E({},o),{},{data:E(E({},o.data),{},{nodes:d||[],linkedNodes:a||{}})}))})};return n(e),t};Object.defineProperty(exports,"ROOT_NODE",{enumerable:!0,get:function(){return e.ROOT_NODE}}),exports.ActionMethodsWithConfig=le,exports.Canvas=Canvas,exports.CoreEventHandlers=ee,exports.DefaultEventHandlers=oe,exports.DerivedCoreEventHandlers=class extends e.DerivedEventHandlers{},exports.Editor=({children:t,...n})=>{void 0!==n.resolver&&l.default("object"==typeof n.resolver&&!Array.isArray(n.resolver)&&null!==n.resolver,e.ERROR_RESOLVER_NOT_AN_OBJECT);const r=i.useRef(n),o=ce(r.current,(t,n,r,o,s)=>{if(!r)return;const{patches:d,...a}=r;for(let r=0;r<d.length;r++){const{path:i}=d[r],l=i.length>2&&"nodes"===i[0]&&"data"===i[2];if([e.HISTORY_ACTIONS.IGNORE,e.HISTORY_ACTIONS.THROTTLE].includes(a.type)&&a.params&&(a.type=a.params[0]),["setState","deserialize"].includes(a.type)||l){s(e=>{t.options.normalizeNodes&&t.options.normalizeNodes(e,n,a,o)});break}}});return i.useEffect(()=>{o&&void 0!==n.enabled&&o.query.getOptions().enabled!==n.enabled&&o.actions.setOptions(e=>{e.enabled=n.enabled})},[o,n.enabled]),i.useEffect(()=>{o.subscribe(e=>({json:o.query.serialize()}),()=>{o.query.getOptions().onNodesChange(o.query)})},[o]),o?i.createElement(N.Provider,{value:o},i.createElement(ae,null,t)):null},exports.Element=k,exports.Events=ae,exports.Frame=({children:n,json:r,data:o})=>{const{actions:s,query:d}=O();r&&e.deprecationWarning("<Frame json={...} />",{suggest:"<Frame data={...} />"});const i=t.useRef(!1);if(!i.current){const t=o||r;if(t)s.history.ignore().deserialize(t);else if(n){const t=a.default.Children.only(n),r=d.parseReactElement(t).toNodeTree((n,r)=>(r===t&&(n.id=e.ROOT_NODE),n));s.history.ignore().addNodeTree(r)}i.current=!0}return a.default.createElement(P,null)},exports.NodeElement=I,exports.NodeHelpers=$,exports.NodeProvider=h,exports.Positioner=ne,exports.QueryMethods=Z,exports.connectEditor=function(e){return t=>n=>{const r=e?M(e):M();return a.default.createElement(t,{...r,...n})}},exports.connectNode=function(e){return function(t){return n=>{const r=b(e);return a.default.createElement(t,{...r,...n})}}},exports.createShadow=re,exports.createTestNodes=ve,exports.createTestState=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{nodes:t,events:n}=e;return E(E(E({},ie),e),{},{nodes:t?ve(t):{},events:E(E({},ie.events),n||{})})},exports.defaultElementProps=S,exports.deprecateCanvasComponent=L,exports.editorInitialState=ie,exports.elementPropToNodeData=w,exports.expectEditorState=(e,t)=>{const{nodes:n}=t,r=v(t,pe),{nodes:o}=e,s=v(e,he);expect(s).toEqual(r);const d=Object.keys(n).reduce((e,t)=>{const r=v(n[t],fe);return e[t]=r,e},{}),a=Object.keys(o).reduce((e,t)=>{const n=v(o[t],ge);return e[t]=n,e},{});expect(a).toEqual(d)},exports.serializeNode=J,exports.useEditor=M,exports.useEditorStore=ce,exports.useEventHandler=m,exports.useNode=b;
//# sourceMappingURL=index.js.map
